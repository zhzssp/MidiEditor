<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>MIDIFile Web Test</title>
</head>

<body>
    <h2>Upload a MIDI File</h2>
    <input type="file" id="fileInput" accept=".mid,.midi" />
    <pre id="output"></pre>

    <script type="module">
        import MIDIFile from 'https://cdn.jsdelivr.net/npm/midifile@2.0.0/+esm';

        const fileInput = document.getElementById('fileInput');
        const output = document.getElementById('output');

        const metaSubtypeMap = {
            0x00: "Sequence Number",
            0x01: "Text Event",
            0x02: "Copyright Notice",
            0x03: "Track Name",
            0x04: "Instrument Name",
            0x05: "Lyric",
            0x06: "Marker",
            0x07: "Cue Point",
            0x20: "MIDI Channel Prefix",
            0x2F: "End of Track",
            0x51: "Set Tempo",
            0x54: "SMTPE Offset",
            0x58: "Time Signature",
            0x59: "Key Signature",
            0x7F: "Sequencer-Specific Meta-event"
        };

        const channelSubtypeMap = {
            0x80: "Note Off",
            0x90: "Note On",
            0xA0: "Polyphonic Key Pressure",
            0xB0: "Controller Change",
            0xC0: "Program Change",
            0xD0: "Channel Pressure",
            0xE0: "Pitch Bend"
        };

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const arrayBuffer = e.target.result;
                try {
                    const midiFile = new MIDIFile(arrayBuffer);

                    const header = midiFile.header;
                    let result = `--- MIDI Header ---\n`;
                    result += `Format: ${header.getFormat()}\n`;
                    result += `Tracks: ${header.getTracksCount()}\n`;
                    result += `Ticks per beat: ${header.getTicksPerBeat()}\n\n`;

                    result += `--- Track Events ---\n`;
                    for (let i = 0; i < header.getTracksCount(); i++) {
                        result += `Track ${i + 1}:\n`;
                        const events = midiFile.getTrackEvents(i);
                        for (let j = 0; j < events.length; j++) {
                            const event = events[j];
                            let line = `  [${j}] delta=${event.delta} type=${event.type}`;

                            // 处理 subtype -> readable name
                            if (event.subtype !== undefined) {
                                const subtypeHex = event.subtype.toString(16);
                                let subtypeStr = '';

                                if (event.type === 'meta') {
                                    subtypeStr = metaSubtypeMap[event.subtype] || `Unknown (0x${subtypeHex})`;
                                } else if (event.type === 'channel') {
                                    subtypeStr = channelSubtypeMap[event.subtype] || `Unknown (0x${subtypeHex})`;
                                } else {
                                    subtypeStr = `0x${subtypeHex}`;
                                }

                                line += ` subtype=${subtypeStr}`;
                            }

                            if (event.text) {
                                line += ` text="${event.text}"`;
                            }

                            result += line + `\n`;
                        }
                        result += `\n`;
                    }

                    output.textContent = result;
                    console.log(result);
                } catch (err) {
                    output.textContent = 'Failed to parse MIDI file: ' + err;
                    console.error(err);
                }
            };

            reader.readAsArrayBuffer(file);
        });
    </script>
</body>

</html>